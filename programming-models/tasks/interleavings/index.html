<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://microsoft.github.io/coyote/programming-models/tasks/interleavings/">
    <link rel="shortcut icon" href="/coyote/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Improving coverage of fine-grained interleavings - Coyote</title>
    <link href="/coyote/css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="/coyote/css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="/coyote/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/coyote/css/highlight.css">
    <link href="../../../css/main.css" rel="stylesheet">
    <link href="../../../css/player-controls.css" rel="stylesheet">
    <link href="../../../css/syntax.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="/coyote/js/jquery-3.2.1.min.js"></script>
    <script src="/coyote/js/bootstrap-3.3.7.min.js"></script>
    <script src="/coyote/js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '/coyote/';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Helping Coyote cover fine-grained interleavings", url: "#_top", children: [
          ]},
          {title: "Instrumenting scheduling points to exercise racy behaviors", url: "#instrumenting-scheduling-points-to-exercise-racy-behaviors", children: [
          ]},
          {title: "Expressing asynchronous behavior in mocks", url: "#expressing-asynchronous-behavior-in-mocks", children: [
          ]},
        ];

    </script>
    <script src="/coyote/js/base.js"></script>
      <script src="https://www.googletagmanager.com/gtag/js?id=UA-89203408-1"></script>
      <script src="https://consentdeliveryfd.azurefd.net/mscc/lib/v2/wcp-consent.js"></script>
      <script src="../../../assets/js/analytics.js"></script>
      <script src="../../../assets/js/plugins.js"></script>
      <script src="../../../assets/js/animate_trace.js"></script>
      <script src="../../../assets/js/animation.js"></script>
      <script src="../../../assets/js/progress_bar.js"></script>
      <script src="../../../assets/js/trace_model.js"></script>
      <script src="../../../assets/js/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>

<div id="cookie-banner"></div>


<div class="wrapper wm-page-content">
  <div class="container-fluid">
    <a name="_top"></a>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../rewriting/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../rewriting/" class="btn btn-xs btn-link">
        Rewriting binaries
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../synchronized-block/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../synchronized-block/" class="btn btn-xs btn-link">
        Controlled synchronized block
      </a>
    </div>
    
  </div>

      

      <h2 id="helping-coyote-cover-fine-grained-interleavings">Helping Coyote cover fine-grained interleavings</h2>
<p>This page covers an advanaced topic of programmtically controlling the interleavings that Coyote
covers during testing. Typically, this should not be needed: the &ldquo;Controlled&rdquo; APIs provided by
Coyote cover a lot of scenarios already. However, if you find yourself working with code that may
potentially have data races, or you are modeling other forms of synchronization not covered by
Coyote already, then you might have to help out the tester a bit more.</p>
<p>During <a href="../../../core/concurrency-unit-testing/">systematic testing</a>, Coyote serializes the concurrent
execution of a program. Serialization means that only one task is running at any given time. This
helps remove the randomness that happens when the operating system schedules parallel tasks and
performs thread switching at unpredictable moments depending on your machine load. It also makes
executions reproducible because Coyote controls the scheduling. This is super useful for debugging.
Coyote, however, does not cover all possible interleavings by default. The interleavings are
complete (i.e., all possible behaviors can be covered by testing, given enough time) for race-free
programs. For programs with racy accesses, you have to help Coyote find more interleavings.</p>
<p>Consider the following code:</p>
<pre><code class="language-c#">int x = 0;

async Task A()
{
    var a = ++x;
    Console.WriteLine(&quot;A: &quot; + a);
    await Task.CompletedTask;
}

async Task B()
{
    var b = ++x;
    Console.WriteLine(&quot;B: &quot; + b);
    await Task.CompletedTask;
}

Task.Run(A);
Task.Run(B);
</code></pre>
<p>This code is setting up an obvious race condition on the variable <code>x</code>.  The production output of
this program can print <code>A: 1, B: 2</code> or <code>A: 2, B: 1</code> and sometimes even <code>A: 1, B: 1</code>.  This is
because the <code>x++</code> operator is not atomic, a thread switch can happen after the read of the value of
<code>x</code> and before the store of the incremented value.  When running the above code under <code>coyote test</code>,
the output will always be <code>A: 1, B: 2</code> or <code>A: 2, B:1</code>.  This is because <code>coyote test</code> runs the tasks
<code>A</code> and <code>B</code> until they either hit a <em>scheduling point</em> or naturally terminate. None of the
statements in either methods is an automatically instrumented scheduling point, so Coyote fails to
test the data-race related concurrency above.</p>
<p>The <code>coyote test</code> tool executes tasks up to a <em>scheduling point</em>, and only then chooses to switch to
another task (or keeps running the same one) and execute it up to the next scheduling point and so
on. The default scheduling points are at Task API granularity (e.g., <code>Task.Run</code>, <code>Task.Delay</code>,
<code>await</code> or <code>Task.WhenAny</code> etc.). This is why the racy-behavior <code>A: 1, B: 1</code> is missed in the above
example: there is no scheduling point between the load of <code>x</code> and the store of its incremented
value.</p>
<h2 id="instrumenting-scheduling-points-to-exercise-racy-behaviors">Instrumenting scheduling points to exercise racy behaviors</h2>
<p>It is generally not safe for multiple tasks to perform non-atomic operations on the same variable at
the same time as this can create data race conditions. Ideally, you should avoid races using
synchronization. You can use a <a href="../semaphore/">Semaphore</a>, for instance, to protect the increment of
<code>x</code>. This rules out the <code>A: 1, B: 1</code> behavior and also makes coyote testing complete (given enough
time).</p>
<p>There may be situations where you cannot avoid the races, for instance when writing mocks for
testing. In that case, use <code>Task.ExploreContextSwitch</code> to introduce a custom scheduling point and
help coyote tester find sneaky bugs due to subtle data races within your code.</p>
<p>You can test this concurrency by introducing an explicit scheduling point using
<code>Task.ExploreContextSwitch</code>:</p>
<pre><code class="language-c#">int x = 0;
int a = 0;
int b = 0;

async Task A()
{
    a = x + 1;
    Task.ExploreContextSwitch();
    x = a;
}

async Task B()
{
    b = x + 1;
    Task.ExploreContextSwitch();
    x = b;
}

public void RunTest()
{
    var t1 = Task.Run(A);
    var t2 = Task.Run(B);
    Task.WaitAll(t1, t2);
    Specification.Assert(a &gt; 1 || b &gt; 1, string.Format(&quot;a = {0} and b = {1}&quot;, a, b));
}
</code></pre>
<p>When you run this with <code>coyote test</code> the specification will sometimes fail with the Assert
<code>&lt;ErrorLog&gt; A: 1, B: 1</code>, which means <code>coyote test</code> can now fully explore behaviors of this program.</p>
<p>Note that <code>Task.ExploreContextSwitch</code> has no effect in production code, it only affects code running
under <code>coyote test</code>.</p>
<h2 id="expressing-asynchronous-behavior-in-mocks">Expressing asynchronous behavior in mocks</h2>
<p>Mocks often don&rsquo;t have true asynchrony (they might just be dummy in-memory calls). In order to force
asynchronous execution when calling such mocks, you need to introduce a scheduling point in them.
One great way to do that is by using <code>Task.Yield</code>. This method, similar to <code>Task.Run</code>, has the
following two properties:</p>
<p>1) As it&rsquo;s a scheduling point, it suspends the currently executing task and gives control back to
     Coyote so it can decide which task to schedule next.</p>
<p>2) <code>Task.Yield</code> introduces a source of asynchrony in the system. The caller of the method that
     yields and the code after the yield can run asynchronously with respect to each other.</p>
<p>Similar to <code>Task.Run</code>, Coyote automatically instruments a scheduling point each time <code>Task.Yield</code> is
called.</p>
<p>The following example illustrates the difference between <code>Task.Yield</code> and
<code>Task.ExploreContextSwitch</code>. Consider two methods <code>FooAsync</code> and <code>BarAsync</code>, where the user calls
<code>FooAsync</code> which in turn calls <code>BarAsync</code>.</p>
<pre><code class="language-c#">async Task BarAsync()
{
    await Task.Yield();
    Console.WriteLine(&quot;I am Bar!&quot;);
}

async Task FooAsync()
{
    BarAsync();
    Console.WriteLine(&quot;I am Foo!&quot;);
    await Task.CompletedTask;
}
</code></pre>
<p>If you call <code>FooAsync</code> above, then due to the asynchrony introduced by <code>Task.Yield</code>, there are two
possible outputs printed:</p>
<pre><code class="language-plain">I am Foo!
I am Bar!
</code></pre>
<p>or</p>
<pre><code class="language-plain">I am Bar!
I am Foo!
</code></pre>
<p>If you now replace <code>Task.Yield</code> with <code>Task.ExploreContextSwitch</code>, as in the following example:</p>
<pre><code class="language-c#">async Task BarAsync()
{
    Task.ExploreContextSwitch();
    Console.WriteLine(&quot;I am Bar!&quot;);
    await Task.CompletedTask;
}

async Task FooAsync()
{
    BarAsync();
    Console.WriteLine(&quot;I am Foo!&quot;);
    await Task.CompletedTask;
}
</code></pre>
<p>Then, you only get one possible output:</p>
<pre><code class="language-plain">I am Bar!
I am Foo!
</code></pre>
<p>This is because when you hit <code>Task.ExploreContextSwitch</code>, the control goes back to Coyote and it
looks to schedule another task, but since there is only <em>one</em> task in the set of enabled tasks, it
is forced to schedule the same task again, which prints <code>I am Bar!</code> and then ends up printing <code>I am
Foo!</code>.</p>
<p>The reason there is only a single task in the above example, is because the <code>await
Task.CompletedTask</code> statements in <code>BarAsync</code> and <code>FooAsync</code> always run synchronously (the task is
already completed after all). Invoking <code>Task.ExploreContextSwitch</code> does not alter execution
semantics, so by itself cannot introduce concurrency where there is none.</p>

    <br>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../rewriting/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../rewriting/" class="btn btn-xs btn-link">
        Rewriting binaries
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../synchronized-block/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../synchronized-block/" class="btn btn-xs btn-link">
        Controlled synchronized block
      </a>
    </div>
    
  </div>

      <br>
  </div>
</div>

<footer class="wm-page-content">
      <p>
        <a href="https://github.com/microsoft/coyote/"><i class="fa fa-github"></i>
GitHub</a>
      </p>

  

<section class="footer-join pt-40 pb-80">
  <div class="container-fluid">
    <div class="row text-center">
      <div class="col-sm-8 col-sm-offset-2">
      </div>
    </div>
    <div class="row">

   </div>
  </div>
</section>
<section class="footer-dark pt-60">
  <div class="container-fluid">
    <div class="row">
      <div class="hidden-xs col-sm-5 col-lg-6">
        <a href="" title="homepage" class="logo-footer">
          <img src="/coyote/assets/images/icon.png" alt="Coyote">
        </a>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Coyote</h4>
          <ul class="list-unstyled">

            <li><a href="/coyote/">Home</a></li>

            <li><a href="/coyote/overview/about">About</a></li>

          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Resources</h4>
          <ul class="list-unstyled">

            <li><a href="/coyote/get-started/install">Install</a></li>

            <li><a href="/coyote/get-started/using-coyote">Getting started</a></li>

          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Community</h4>
          <ul class="list-unstyled">

            <li><a href="https://github.com/microsoft/coyote" target="_blank">GitHub</a></li>

            <li><a href="https://gitter.im/microsoft/coyote" target="_blank">Gitter</a></li>

          </ul>
        </nav>
      </div>

    </div>

    <div class="row footnote pt-50 pb-20">
      <div class="col-sm-12">
        <hr>
      </div>
      <div class="col-sm-6">
        <ul class="list-unstyled list-inline footnote-copy">

          <li><a href="https://privacy.microsoft.com/en-us/privacystatement/" target="_blank">Privacy</a></li>

          <li><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/copyright/default.aspx" target="_blank">Terms of Use</a></li>

          <li><a href="https://github.com/microsoft/coyote/blob/main/LICENSE" target="_blank">License</a></li>

          <li><a href="javascript:manageCookies()">Cookies</a></li>

        </ul>
      </div>
      <div class="col-sm-6 text-right footnote-copy">
        <ul class="list-unstyled list-inline">
          <li><span id="copyright"></span></li>
          <li><a href="https://www.microsoft.com/" target="_blank"><img class="img-responsive" src="/coyote/assets/images/microsoft-logo.svg?v=3" alt="Microsoft">&nbsp;</a></li>
        </ul>
      </div>
    </div>
  </div>
</section>
</footer>


<script type="text/javascript">
    $(document).ready(function () {
      $('table').each(function () {
        $(this).addClass("table");
        $(this).addClass("table-bordered");
        $(this).addClass("table-striped");
        $(this).addClass("table-condensed");
      });

    });
</script>

</body>
</html>