<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://microsoft.github.io/coyote/tools/rewriting/">
    <link rel="shortcut icon" href="/coyote/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Rewriting tool - Coyote</title>
    <link href="/coyote/css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="/coyote/css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="/coyote/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/coyote/css/highlight.css">
    <link href="../../css/main.css" rel="stylesheet">
    <link href="../../css/player-controls.css" rel="stylesheet">
    <link href="../../css/syntax.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="/coyote/js/jquery-3.2.1.min.js"></script>
    <script src="/coyote/js/bootstrap-3.3.7.min.js"></script>
    <script src="/coyote/js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '/coyote/';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Coyote rewriting tool", url: "#_top", children: [
              {title: "Example usage", url: "#example-usage" },
              {title: "Configuration", url: "#configuration" },
              {title: "Strong name signing", url: "#strong-name-signing" },
              {title: "Troubleshooting", url: "#troubleshooting" },
          ]},
        ];

    </script>
    <script src="/coyote/js/base.js"></script>
      <script src="https://www.googletagmanager.com/gtag/js?id=UA-89203408-1"></script>
      <script src="https://consentdeliveryfd.azurefd.net/mscc/lib/v2/wcp-consent.js"></script>
      <script src="../../assets/js/analytics.js"></script>
      <script src="../../assets/js/plugins.js"></script>
      <script src="../../assets/js/animate_trace.js"></script>
      <script src="../../assets/js/animation.js"></script>
      <script src="../../assets/js/progress_bar.js"></script>
      <script src="../../assets/js/trace_model.js"></script>
      <script src="../../assets/js/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>

<div id="cookie-banner"></div>


<div class="wrapper wm-page-content">
  <div class="container-fluid">
    <a name="_top"></a>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../unit-testing/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../unit-testing/" class="btn btn-xs btn-link">
        Unit testing
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../testing/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../testing/" class="btn btn-xs btn-link">
        Testing
      </a>
    </div>
    
  </div>

      

      <h2 id="coyote-rewriting-tool">Coyote rewriting tool</h2>
<p>The <code>coyote</code> command line tool can be used to automatically rewrite any .NET binary to take over
concurrency that is built using <code>System.Threading.Tasks.Task</code>. For details on what kinds of
rewriting is supported see <a href="../../advanced-topics/tasks/rewriting/">Rewriting binaries</a>.</p>
<p>To invoke the rewriter use the following command:</p>
<pre><code class="language-plain">coyote rewrite ${YOUR_PROGRAM}
</code></pre>
<p>See <a href="../../get-started/using-coyote/">Using coyote</a> for information on where to find the
<code>coyote</code> tool.</p>
<p><code>${YOUR_PROGRAM}</code> is the path to your application or library to be rewritten or a folder containing
all the libraries you want rewritten.</p>
<p>Type <code>coyote rewrite -?</code> to see the full command line options. If you are using the .NET Core
version of <code>coyote</code> then you simply run <code>dotnet coyote.dll ...</code> instead.</p>
<h3 id="example-usage">Example usage</h3>
<p>The <a href="https://github.com/microsoft/coyote-samples/tree/main/BoundedBuffer">BoundedBuffer example</a>
is written with <code>System.Threading.Tasks.Task</code>. It does not start with <code>using
Microsoft.Coyote.Tasks</code>. So <code>BoundedBuffer.cs</code> is pure .NET C# code that knows nothing about Coyote
types.</p>
<p>However, using <code>coyote rewrite</code> we can make it testable under <code>coyote test</code> tool as follows:</p>
<ol>
<li>Build BoundedBuffer.sln</li>
<li>coyote rewrite bin\net5.0\BoundedBuffer.dll</li>
<li>coyote test bin\net5.0\BoundedBuffer.dll -m TestBoundedBufferMinimalDeadlock -i 100</li>
</ol>
<p>Notice that the test runs, it finds a bug and the produced log file contains the error:</p>
<pre><code class="language-plain">Deadlock detected. Task(0) is waiting for a task to complete,
but no other controlled tasks are enabled.
</code></pre>
<p>If this code was running in production mode it would have deadlocked and the test would not
complete. Deadlock detection and reporting in the log file is only made possible when the <code>coyote
test</code> tool can take over all concurrency, and this was made possible by the <code>coyote rewrite</code> step.</p>
<h3 id="configuration">Configuration</h3>
<p>You can provide more rewriting options in a JSON file like this:</p>
<pre><code class="language-json">{
  &quot;AssembliesPath&quot;: &quot;bin/net5.0&quot;,
  &quot;OutputPath&quot;: &quot;bin/net5.0/rewritten&quot;,
  &quot;Assemblies&quot;: [
    &quot;BoundedBuffer.dll&quot;,
    &quot;MyOtherLibrary.dll&quot;,
    &quot;FooBar123.dll&quot;
  ]
}
</code></pre>
<ul>
<li>
<p><code>AssembliesPath</code> is the folder containing the original binaries.  This property is required.</p>
</li>
<li>
<p><code>OutputPath</code> allows you to specify a different location for the rewritten assemblies. The
<code>OutputPath</code> can be omitted in which case it is assumed to be the same as <code>AssembliesPath</code> and in
that case the original assemblies will be replaced.</p>
</li>
<li>
<p><code>Assemblies</code> is an optional list of specific assemblies in <code>AssembliesPath</code> to be rewritten. You
can also pull in another assembly by providing a full path to something outside the
<code>AssembliesPath</code>. If this list is not provided then the tool will rewrite all assemblies found in
the specified <code>AssembliesPath</code>.</p>
</li>
</ul>
<p>Then pass this config file on the command line: <code>coyote rewrite config.json</code>.</p>
<h3 id="strong-name-signing">Strong name signing</h3>
<p>For .NET 4.7 and 4.8, you may need to resign your rewritten binaries in order for tests to run
properly. This can be done by providing the same strong name key that you provided during the
original build. This can be done using the <code>--strong-name-key-file</code> command line argument (or
<code>-snk</code> for the abbreviated option name).</p>
<p>For example, from your <code>coyote</code> repo:</p>
<pre><code class="language-plain">bin\net48\coyote rewrite d:\git\foundry99\Coyote\Tests\Tests.SystematicTesting\bin\net48\rewrite.coyote.json --strong-name-key-file Common\Key.snk
</code></pre>
<p>You can also provide this key in the JSON file using the <code>StrongNameKeyFile</code> property.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<p><strong>Format of the executable (.exe) or library (.dll) is invalid.</strong></p>
<p>If you are using a .NET Core target platform then on Windows you will get executable program with
<code>.exe</code> file extension, like <code>coyote-samples\bin\net5.0\BoundedBuffer.exe</code> These are not
rewritable assemblies. You must instead rewrite and test the associated library, in this case
<code>BoundedBuffer.dll</code>.</p>

    <br>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../unit-testing/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../unit-testing/" class="btn btn-xs btn-link">
        Unit testing
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../testing/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../testing/" class="btn btn-xs btn-link">
        Testing
      </a>
    </div>
    
  </div>

      <br>
  </div>
</div>

<footer class="wm-page-content">
      <p>
        <a href="https://github.com/microsoft/coyote/"><i class="fa fa-github"></i>
GitHub</a>
      </p>

  

<section class="footer-join pt-40 pb-80">
  <div class="container-fluid">
    <div class="row text-center">
      <div class="col-sm-8 col-sm-offset-2">
      </div>
    </div>
    <div class="row">

   </div>
  </div>
</section>
<section class="footer-dark pt-60">
  <div class="container-fluid">
    <div class="row">
      <div class="hidden-xs col-sm-5 col-lg-6">
        <a href="" title="homepage" class="logo-footer">
          <img src="/coyote/assets/images/icon.png" alt="Coyote">
        </a>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Coyote</h4>
          <ul class="list-unstyled">

            <li><a href="/coyote/">Home</a></li>

            <li><a href="/coyote/overview/about">About</a></li>

          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Resources</h4>
          <ul class="list-unstyled">

            <li><a href="/coyote/get-started/install">Install</a></li>

            <li><a href="/coyote/get-started/using-coyote">Getting started</a></li>

          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Community</h4>
          <ul class="list-unstyled">

            <li><a href="https://github.com/microsoft/coyote" target="_blank">GitHub</a></li>

            <li><a href="https://gitter.im/microsoft/coyote" target="_blank">Gitter</a></li>

          </ul>
        </nav>
      </div>

    </div>

    <div class="row footnote pt-50 pb-20">
      <div class="col-sm-12">
        <hr>
      </div>
      <div class="col-sm-6">
        <ul class="list-unstyled list-inline footnote-copy">

          <li><a href="https://privacy.microsoft.com/en-us/privacystatement/" target="_blank">Privacy</a></li>

          <li><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/copyright/default.aspx" target="_blank">Terms of Use</a></li>

          <li><a href="https://github.com/microsoft/coyote/blob/main/LICENSE" target="_blank">License</a></li>

          <li><a href="javascript:manageCookies()">Cookies</a></li>

        </ul>
      </div>
      <div class="col-sm-6 text-right footnote-copy">
        <ul class="list-unstyled list-inline">
          <li><span id="copyright"></span></li>
          <li><a href="https://www.microsoft.com/" target="_blank"><img class="img-responsive" src="/coyote/assets/images/microsoft-logo.svg?v=3" alt="Microsoft">&nbsp;</a></li>
        </ul>
      </div>
    </div>
  </div>
</section>
</footer>


<script type="text/javascript">
    $(document).ready(function () {
      $('table').each(function () {
        $(this).addClass("table");
        $(this).addClass("table-bordered");
        $(this).addClass("table-striped");
        $(this).addClass("table-condensed");
      });

    });
</script>

</body>
</html>