<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://microsoft.github.io/coyote/tutorials/mock-dependencies/">
    <link rel="shortcut icon" href="/coyote/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Mock dependencies - Coyote</title>
    <link href="/coyote/css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="/coyote/css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="/coyote/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/coyote/css/highlight.css">
    <link href="../../css/main.css" rel="stylesheet">
    <link href="../../css/player-controls.css" rel="stylesheet">
    <link href="../../css/syntax.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="/coyote/js/jquery-3.2.1.min.js"></script>
    <script src="/coyote/js/bootstrap-3.3.7.min.js"></script>
    <script src="/coyote/js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '/coyote/';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Mocking dependencies for systematic testing", url: "#_top", children: [
          ]},
          {title: "What you will need", url: "#what-you-will-need", children: [
          ]},
          {title: "Walkthrough", url: "#walkthrough", children: [
          ]},
        ];

    </script>
    <script src="/coyote/js/base.js"></script>
      <script src="https://www.googletagmanager.com/gtag/js?id=UA-89203408-1"></script>
      <script src="https://consentdeliveryfd.azurefd.net/mscc/lib/v2/wcp-consent.js"></script>
      <script src="../../assets/js/analytics.js"></script>
      <script src="../../assets/js/plugins.js"></script>
      <script src="../../assets/js/animate_trace.js"></script>
      <script src="../../assets/js/animation.js"></script>
      <script src="../../assets/js/progress_bar.js"></script>
      <script src="../../assets/js/trace_model.js"></script>
      <script src="../../assets/js/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>

<div id="cookie-banner"></div>


<div class="wrapper wm-page-content">
  <div class="container-fluid">
    <a name="_top"></a>
      

      

      <h2 id="mocking-dependencies-for-systematic-testing">Mocking dependencies for systematic testing</h2>
<p>Mocking dependencies is a common activity when writing unit tests. The code that you want to test
often depends on other (complex) code, such as third-party libraries and external services (e.g.
<a href="https://azure.microsoft.com/services/cosmos-db/">Cosmos DB</a>). These dependencies might be
impractical to include in the test (e.g. use storage or network), so you want to replace them with
(much) simpler implementations that simulate the real behavior. One popular way to replace real
dependencies with mocks is via <a href="https://en.wikipedia.org/wiki/Dependency_injection">dependency
injection</a>.</p>
<p>Mocks play an even more important role when <a href="../../concepts/concurrency-unit-testing/">writing concurrency unit
tests</a>. Coyote explores different interleavings during each
testing iteration, so you have to write mocks that simulate the behavior of the real dependency by
returning the correct response no matter which interleaving is explored. This means that when
testing with Coyote, you need to design mocks with concurrency in mind.</p>
<p>In this tutorial, you will write a simple mock for the <code>IDbCollection</code> that was introduced in the
<a href="../first-concurrency-unit-test/">write your first concurrency unit test</a> tutorial. We&rsquo;ll design our
class to be used in a concurrent setting, where methods in multiple instances of the class can be
called concurrently, either within the same process or across processes and machines. This latter
condition means that using locks will not help you in writing correct concurrent code.</p>
<h2 id="what-you-will-need">What you will need</h2>
<p>To run the <code>AccountManager</code> example, you will need to:</p>
<ul>
<li>Install <a href="https://visualstudio.microsoft.com/downloads/">Visual Studio 2019</a>.</li>
<li>Install the <a href="../../get-started/install/">.NET 5.0 version of the coyote tool</a>.</li>
<li>Be familiar with the <code>coyote</code> tool. See <a href="../../get-started/using-coyote/">Testing</a>.</li>
</ul>
<h2 id="walkthrough">Walkthrough</h2>
<p>Consider a typical mock written for a regular unit test.</p>
<pre><code class="language-csharp">var mockCollection = new Mock&lt;IDbCollection&gt;();
mockCollection.Setup(c =&gt; c.DoesRowExist(&quot;joe&quot;)).Returns(true);
mockCollection.Setup(c =&gt; c.CreateUser(&quot;joe&quot;, ...)).Returns(true);

var userAccountManager = new UserAccountManager(mockCollection);

var result = await userAccountManager.CreateUser(&quot;joe&quot;, payload);
Assert.IsTrue(result);
</code></pre>
<p>While the above test works perfectly for sequential tests, it doesn&rsquo;t work when wr write concurrent tests. Consider the following concurrent test.</p>
<pre><code class="language-csharp">var mockCollection = new Mock&lt;IDbCollection&gt;();
mockCollection.Setup(c =&gt; c.DoesRowExist(&quot;joe&quot;)).Returns(false);
mockCollection.Setup(c =&gt; c.CreateUser(&quot;joe&quot;, ...)).Returns(true);

var userAccountManager = new UserAccountManager(mockCollection);

var task1 = userAccountManager.CreateUser(&quot;joe&quot;, payload);
var task2 = userAccountManager.CreateUser(&quot;joe&quot;, payload);

Assert.IsTrue(task1.Result ^ task2.Result);
</code></pre>
<p>The above mock will fail as both the calls to <code>CreateUser</code> succeed as <code>DoesRowExist</code> returns false no matter what. <code>DoesRowExist</code> should only return false if the user doesn&rsquo;t exist. Let&rsquo;s fix it.</p>
<pre><code class="language-csharp">bool userExists = false;
var mockCollection = new Mock&lt;IDbCollection&gt;();
mockCollection.Setup(c =&gt; c.DoesRowExist(&quot;joe&quot;)).Returns(userExists);
mockCollection
  .Setup(c =&gt; c.CreateUser(&quot;joe&quot;, ...))
  .Returns(() =&gt;
  {
     if (userExists)
     {
       throw new RowAlreadyExists();
     }

     userExists = true;
     return true;
  });
</code></pre>
<p>The above mock is a bit more complicated but models the <code>DoesRowExist</code> behavior properly.</p>
<p>If you run the test above, while the assertion will pass, it will also pass for a buggy implementation of <code>CreateUser</code>.</p>
<p>Why is that?</p>
<p>While we invoke the two tasks at the same time, there is no <em>actual</em> concurrency in the code path which means the two calls effectively execute sequentially.</p>
<p>In order to test the true asynchrony in the system, we&rsquo;ll have to write a mock which will spawn a new task whenever <code>DoesRowExist</code> or <code>CreateRow</code> methods are called.</p>
<pre><code class="language-csharp">public class MockDbCollection : IDbCollection
{
   private bool doesUserExist = false;

   public Task&lt;bool&gt; DoesRowExist(string key)
   {
     return Task.Run(() =&gt;
     {
       return doesUserExist;
     });
   }

   public Task&lt;bool&gt; CreateRow(string key, string value)
   {
     return Task.Run(() =&gt;
     {
        if (doesUserExist)
        {
          throw new RowAlreadyExists();
        }

        doesUserExist = true;
        return true;
     });
   }
}
</code></pre>
<p>If you run the test using the above mocked out implementation of IDbCollection, you&rsquo;ll find that the test case catches the bug in the faulty implementation of <code>CreateUser</code>. The introduction of <code>Task.Run</code> in the above methods introduces true asynchrony in the system, similar to how the production implementation of IDbCollection would spawn new tasks when it makes network calls so as not to block the rest of the system.</p>
<p>Can we make the above mock a bit more generally applicable, so we don&rsquo;t have to write custom mocks for each test case? What if we turned it into a simple <code>simulator</code> which simulated the behavior of actual IDbCollection?</p>
<p>Most external dependencies tend to have very simple simulators and a little effort in writing the simulator can yield large productivity gains.</p>
<p>Let&rsquo;s write out an IDbCollection simulator which we can use in our tests.</p>
<pre><code class="language-csharp">public class MockDbCollection : IDbCollection
{
   private ConcurrentDictionary&lt;string, string&gt; collection;

   public Task&lt;bool&gt; DoesRowExist(string key)
   {
     return Task.Run(() =&gt;
     {
       return collection.ContainsKey(key);
     });
   }

   public Task&lt;bool&gt; CreateRow(string key, string value)
   {
     return Task.Run(() =&gt;
     {
        var success = collection.TryAdd(key, value);
        if (!success)
        {
          throw new RowAlreadyExists();
        }

        return true;
     });
   }
}
</code></pre>
<p>Through a very simple change, we now have a simple simulator which can model the behavior of adding rows and checking for their existence which we can use in our concurrency tests. Simulators are often surprisingly easy to write and have the benefit that they can be reused in multiple tests. Simulators can also be written in a &ldquo;pay-as-you-go&rdquo; fashion where the initial implementation can be simple and more functionality can be added as we go along. We&rsquo;ll see an example of this later in this article.</p>
<p>Let&rsquo;s make our simulator complete by implementing the <code>GetRow</code> and <code>DeleteRow</code> methods.</p>
<pre><code class="language-csharp">public Task&lt;string&gt; GetRow(string key)
{
  return Task.Run(() =&gt;
  {
     var success = collection.TryAdd(key, out string value);
     if (!success)
     {
       throw new RowNotFound();
     }

     return value;
  });
}

public Task&lt;bool&gt; DeleteRow(string key)
{
  return Task.Run(() =&gt;
  {
     var success = collection.TryRemove(key);
     if (!success)
     {
       throw new RowNotFound();
     }

     return true;
  });
}
</code></pre>
<p>With the above simulator, we will be able to write a bunch of concurrent test cases without having to write custom mocks for each of them. You can find the implementation over <a href="https://github.com">here</a></p>
<p>We&rsquo;ll explore how to add support for ETags for optimistic concurrency control in the next article. Adding support for ETags combined with Coyote&rsquo;s concurrency testing will allow us to test a scenario which is fairly hard to hit in production but can lead to data loss.</p>

    <br>
      

      <br>
  </div>
</div>

<footer class="wm-page-content">
  

<section class="footer-join pt-40 pb-80">
  <div class="container-fluid">
    <div class="row text-center">
      <div class="col-sm-8 col-sm-offset-2">
      </div>
    </div>
    <div class="row">
   </div>
  </div>
</section>
<section class="footer-dark pt-60">
  <div class="container-fluid">
    <div class="row">
      <div class="hidden-xs col-sm-5 col-lg-6">
        <a href="" title="homepage" class="logo-footer">
          <img src="/coyote/assets/images/icon.png" alt="Coyote">
        </a>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Coyote</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/">Home</a></li>
            <li><a href="/coyote/get-started/install">Install</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Resources</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/tutorials/first-concurrency-unit-test">Getting started</a></li>
            <li><a href="/coyote/tutorials/overview">Tutorials</a></li>
            <li><a href="/coyote/ref/Microsoft.Coyote">API documentation</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Community</h4>
          <ul class="list-unstyled">
            <li><a href="https://github.com/microsoft/coyote/"><i class="fa fa-github"></i>
GitHub</a></li>
            <li><a href="https://twitter.com/coyote_dev" target="_blank"><i class="fa fa-twitter"></i> Twitter</a></li>
            <li><a href="https://gitter.im/microsoft/coyote" target="_blank">Gitter</a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="row footnote pt-50 pb-20">
      <div class="col-sm-12">
        <hr>
      </div>
      <div class="col-sm-6">
        <ul class="list-unstyled list-inline footnote-copy">
          <li><a href="https://privacy.microsoft.com/en-us/privacystatement/" target="_blank">Privacy</a></li>
          <li><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/copyright/default.aspx" target="_blank">Terms of Use</a></li>
          <li><a href="https://github.com/microsoft/coyote/blob/main/LICENSE" target="_blank">License</a></li>
          <li><a href="javascript:manageCookies()">Cookies</a></li>
        </ul>
      </div>
      <div class="col-sm-6 text-right footnote-copy">
        <ul class="list-unstyled list-inline">
          <li><span id="copyright"></span></li>
          <li><a href="https://www.microsoft.com/" target="_blank"><img class="img-responsive" src="/coyote/assets/images/microsoft-logo.svg?v=3" alt="Microsoft">&nbsp;</a></li>
        </ul>
      </div>
    </div>
  </div>
</section>
</footer>


<script type="text/javascript">
    $(document).ready(function () {
      $('table').each(function () {
        $(this).addClass("table");
        $(this).addClass("table-bordered");
        $(this).addClass("table-striped");
        $(this).addClass("table-condensed");
      });

    });
</script>

</body>
</html>